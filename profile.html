<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Explore the World</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .profile-section {
            padding-top: 6rem;
            min-height: 100vh;
        }
        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .profile-picture {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 1.5rem;
        }
        .profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .profile-picture .edit-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #0d6efd;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .profile-picture .edit-icon:hover {
            background: #0b5ed7;
            transform: scale(1.1);
        }
        .profile-picture input[type="file"] {
            display: none;
        }
        .auth-required {
            display: none;
        }
        .progress {
            display: none;
            margin-top: 15px;
        }
        .profile-form {
            max-width: 500px;
            margin: 0 auto;
        }
        .user-stats {
            margin-top: 3rem;
            background-color: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
            padding: 1.5rem;
        }
        .stat-card {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: default;
        }
        .stat-card:hover {
            background-color: #f0f0f0;
            transform: translateY(-5px);
        }
        .stat-card i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #0d6efd;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .stat-title {
            color: #6c757d;
            font-size: 0.9rem;
        }
        /* Image Upload Styles */
        .upload-form {
            max-width: 600px;
            margin: 0 auto;
        }
        .image-upload-progress {
            height: 20px;
            margin-top: 15px;
        }
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            margin: 10px auto;
            display: none;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: contain;
        }
        /* My Uploads Grid Styles */
        .upload-card {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .upload-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .upload-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .upload-card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 15px;
            color: white;
        }
        .upload-card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .upload-card-info {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        .upload-card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .delete-btn {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .delete-btn:hover {
            background: rgb(220, 53, 69);
        }
        .upload-card-category {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        /* Dark mode styles */
        [data-theme="dark"] .card {
            background-color: #2d3436;
            border-color: #4a5568;
        }
        
        [data-theme="dark"] .card-body {
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .card-title {
            color: #f1f5f9;
        }
        
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .input-group-text {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] .form-select:focus {
            background-color: #2d3748;
            border-color: #63b3ed;
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .form-text,
        [data-theme="dark"] .text-muted {
            color: #a0aec0 !important;
        }
        
        [data-theme="dark"] .nav-tabs {
            border-bottom-color: #4a5568;
        }
        
        [data-theme="dark"] .nav-tabs .nav-link {
            color: #a0aec0;
        }
        
        [data-theme="dark"] .nav-tabs .nav-link:hover {
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .nav-tabs .nav-link.active {
            background-color: #2d3436;
            border-color: #4a5568;
            border-bottom-color: #2d3436;
            color: #63b3ed;
        }
        
        [data-theme="dark"] .form-check-input {
            background-color: #1a202c;
            border-color: #4a5568;
        }
        
        [data-theme="dark"] .form-check-input:checked {
            background-color: #63b3ed;
            border-color: #63b3ed;
        }
        
        [data-theme="dark"] .form-check-label {
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .upload-area {
            background-color: #1a202c;
            border-color: #4a5568;
        }
        
        [data-theme="dark"] .upload-placeholder {
            color: #a0aec0;
        }
        
        [data-theme="dark"] .user-stats {
            background-color: #2d3436;
        }
        
        [data-theme="dark"] .stat-card:hover {
            background-color: #1a202c;
        }
        
        [data-theme="dark"] .stat-title {
            color: #a0aec0;
        }
        
        [data-theme="dark"] .activity-timeline {
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .activity-item {
            border-color: #4a5568;
        }
        
        [data-theme="dark"] hr {
            border-color: #4a5568;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-globe-americas"></i> Explore the World
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="destinations.html">Destinations</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="travel-tips.html">Tips</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="gallery.html">Gallery</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tools.html">Tools</a>
                    </li>
                </ul>
                <!-- Header User Info -->
                <div id="header-user-info" class="d-none d-lg-flex align-items-center ms-3 me-3">
                    <!-- Will be populated by auth.js -->
                </div>
                <!-- Auth Navigation -->
                <ul class="navbar-nav ms-auto auth-nav">
                    <!-- Will be populated by auth.js -->
                </ul>
                <!-- Theme Toggle -->
                <div class="theme-toggle-container">
                    <label class="theme-toggle">
                        <input type="checkbox" id="theme-toggle">
                        <span class="theme-toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="profile-section py-5">
        <div class="container">
            <!-- Login Required Message -->
            <div class="auth-required alert alert-warning text-center">
                <p class="mb-0">You need to <a href="login.html" class="alert-link">log in</a> to view your profile.</p>
            </div>
            
            <!-- Profile Content (Only visible when logged in) -->
            <div id="profileContent" style="display: none;">
                <div class="profile-header">
                    <div class="profile-cover">
                        <div class="profile-cover-overlay"></div>
                    </div>
                    <div class="profile-picture">
                        <img id="userPhoto" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23e2e8f0' d='M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 128c39.77 0 72 32.23 72 72S295.8 272 256 272c-39.77 0-72-32.23-72-72S216.2 128 256 128zM256 448c-52.93 0-100.9-21.53-135.7-56.29C136.5 349.9 176.5 320 224 320h64c47.54 0 87.54 29.88 103.7 71.71C356.9 426.5 308.9 448 256 448z'/%3E%3C/svg%3E" alt="Profile Picture">
                        <label for="profilePictureInput" class="edit-icon">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="profilePictureInput" accept="image/*">
                    </div>
                    <h2 id="displayNameHeader">Loading...</h2>
                    <p id="userEmail" class="text-muted">Loading...</p>
                    <div class="profile-extra-info">
                        <span class="joined-date"><i class="fas fa-clock"></i> <span id="joinedDate">Joined: Loading...</span></span>
                        <span class="profile-location"><i class="fas fa-map-marker-alt"></i> <span id="userLocation">Location: N/A</span></span>
                        <span class="profile-status"><i class="fas fa-circle"></i> Active Now</span>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Profile Tabs Navigation -->
                        <ul class="nav nav-tabs profile-tabs mb-4" id="profileTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit-profile" type="button" role="tab" aria-controls="edit-profile" aria-selected="true">
                                    <i class="fas fa-user-edit"></i> Edit Profile
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="uploads-tab" data-bs-toggle="tab" data-bs-target="#uploads" type="button" role="tab" aria-controls="uploads" aria-selected="false">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="my-uploads-tab" data-bs-toggle="tab" data-bs-target="#my-uploads" type="button" role="tab" aria-controls="my-uploads" aria-selected="false">
                                    <i class="fas fa-images"></i> My Uploads
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Tab Contents -->
                        <div class="tab-content" id="profileTabContent">
                            <!-- Edit Profile Tab -->
                            <div class="tab-pane fade show active" id="edit-profile" role="tabpanel" aria-labelledby="edit-tab">
                                <div class="card shadow-sm">
                                    <div class="card-body p-4">
                                        <h3 class="card-title">Edit Profile</h3>
                                        <hr class="my-3">
                                        
                                        <!-- Profile Update Form -->
                                        <form id="profileForm" class="profile-form">
                                            <div class="mb-3">
                                                <label for="displayName" class="form-label">Display Name</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                                    <input type="text" class="form-control" id="displayName" required>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="userBio" class="form-label">About Me <small class="text-muted">(Optional)</small></label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-info-circle"></i></span>
                                                    <textarea class="form-control" id="userBio" rows="3" placeholder="Share a bit about yourself and your travel interests..."></textarea>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="favoriteDestination" class="form-label">Favorite Destination <small class="text-muted">(Optional)</small></label>
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i class="fas fa-map-marked-alt"></i></span>
                                                        <input type="text" class="form-control" id="favoriteDestination" placeholder="e.g., Paris, Tokyo, Bali">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="location" class="form-label">Your Location <small class="text-muted">(Optional)</small></label>
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i class="fas fa-location-arrow"></i></span>
                                                        <input type="text" class="form-control" id="location" placeholder="e.g., New York, USA">
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label d-block">Privacy Settings</label>
                                                <div class="privacy-settings-container">
                                                    <div class="privacy-setting">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="shareProfile" checked>
                                                            <label class="form-check-label" for="shareProfile">
                                                                Show my profile picture on my gallery uploads
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="privacy-setting">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="receiveNotifications" checked>
                                                            <label class="form-check-label" for="receiveNotifications">
                                                                Receive email notifications about likes and comments
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="privacy-setting">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="publicProfile" checked>
                                                            <label class="form-check-label" for="publicProfile">
                                                                Make my profile visible to other users
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="progress">
                                                <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            
                                            <div class="d-grid mt-4">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-save me-2"></i>Save Changes
                                                </button>
                                            </div>
                                            
                                            <div id="profileMessage" class="mt-3 text-center"></div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload Tab -->
                            <div class="tab-pane fade" id="uploads" role="tabpanel" aria-labelledby="uploads-tab">
                                <div class="card shadow-sm">
                                    <div class="card-body p-4">
                                        <h3 class="card-title">
                                            <i class="fas fa-cloud-upload-alt me-2"></i>Upload Image
                                        </h3>
                                        <hr class="my-3">
                                        
                                        <!-- Image Upload Form -->
                                        <form id="uploadForm" class="upload-form">
                                            <div class="mb-3">
                                                <label for="imageTitle" class="form-label">Image Title</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-heading"></i></span>
                                                    <input type="text" class="form-control" id="imageTitle" required>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="imageDescription" class="form-label">Description</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-comment-alt"></i></span>
                                                    <textarea class="form-control" id="imageDescription" rows="3" required></textarea>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="imageCategory" class="form-label">Category</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                                    <select class="form-select" id="imageCategory" required>
                                                        <option value="">Select a category</option>
                                                        <option value="nature">Nature</option>
                                                        <option value="cities">Cities</option>
                                                        <option value="culture">Culture</option>
                                                        <option value="food">Food</option>
                                                        <option value="adventure">Adventure</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-4">
                                                <label for="imageFile" class="form-label d-block">Choose Image</label>
                                                <div class="upload-area">
                                                    <input class="form-control" type="file" id="imageFile" accept="image/*" required hidden>
                                                    <label for="imageFile" class="upload-label">
                                                        <div class="upload-placeholder">
                                                            <i class="fas fa-cloud-upload-alt"></i>
                                                            <p>Drag & drop your image or click to browse</p>
                                                            <span class="upload-info">Maximum size: 5MB | Formats: JPG, PNG, GIF</span>
                                                        </div>
                                                        <img id="imagePreview" class="img-fluid rounded shadow-sm" style="max-height: 300px; display: none;">
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="image-upload-progress progress" style="display: none;">
                                                <div id="imageUploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            
                                            <div class="d-grid mt-4">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-upload me-2"></i>Upload Image
                                                </button>
                                            </div>
                                            
                                            <div id="uploadMessage" class="mt-3 text-center"></div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- My Uploads Tab -->
                            <div class="tab-pane fade" id="my-uploads" role="tabpanel" aria-labelledby="my-uploads-tab">
                                <div class="card shadow-sm">
                                    <div class="card-body p-4">
                                        <h3 class="card-title mb-4">My Uploaded Images</h3>
                                        <div id="my-uploads-grid" class="row g-4">
                                            <!-- Images will be loaded here dynamically -->
                                        </div>
                                        <div id="no-uploads-message" class="text-center py-5 d-none">
                                            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                            <p class="text-muted">You haven't uploaded any images yet.</p>
                                            <button class="btn btn-primary btn-sm" onclick="document.getElementById('uploads-tab').click()">
                                                Upload Your First Image
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mt-4 mt-lg-0">
                        <!-- User Stats -->
                        <div class="user-stats">
                            <h4 class="mb-4">Your Activity</h4>
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="stat-card">
                                        <i class="fas fa-image"></i>
                                        <div id="uploadCount" class="stat-value">0</div>
                                        <div class="stat-title">Images Uploaded</div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="stat-card">
                                        <i class="fas fa-heart"></i>
                                        <div id="likesCount" class="stat-value">0</div>
                                        <div class="stat-title">Likes Received</div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="stat-card">
                                        <i class="fas fa-comment"></i>
                                        <div id="commentsCount" class="stat-value">0</div>
                                        <div class="stat-title">Comments Received</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="card shadow-sm mt-4">
                            <div class="card-body">
                                <h4 class="card-title mb-3">Recent Activity</h4>
                                <div class="activity-timeline" id="activity-timeline">
                                    <!-- Activities will be loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Toast Container -->
            <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4 mb-lg-0">
                    <h5 class="text-white">Explore the World</h5>
                    <p class="text-muted">Your ultimate guide to discovering the world's most beautiful destinations, travel tips, and cultural insights.</p>
                    <div class="social-icons">
                        <a href="#" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-icon"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-icon"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-icon"><i class="fab fa-pinterest"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 mb-4 mb-md-0">
                    <h5 class="text-white">Quick Links</h5>
                    <ul class="list-unstyled footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="destinations.html">Destinations</a></li>
                        <li><a href="gallery.html">Gallery</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-4 mb-4 mb-md-0">
                    <h5 class="text-white">Resources</h5>
                    <ul class="list-unstyled footer-links">
                        <li><a href="packing-essentials.html">Packing Guides</a></li>
                        <li><a href="travel-insurance.html">Travel Insurance</a></li>
                        <li><a href="#">FAQs</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="col-lg-4 col-md-4">
                    <h5 class="text-white">Newsletter</h5>
                    <p class="text-muted">Subscribe to receive travel inspiration and exclusive offers.</p>
                    <form class="newsletter-form">
                        <div class="input-group">
                            <input type="email" class="form-control" placeholder="Your email address" required>
                            <button class="btn btn-primary" type="submit">Subscribe</button>
                        </div>
                    </form>
                </div>
            </div>
            <hr class="mt-4 mb-3 footer-divider">
            <div class="row">
                <div class="col-md-12 text-center">
                    <p class="mb-0 copyright">© 2023 Explore the World. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAb6bp6ot5tWz16b1qJzv_30VxJR87nzW8",
            authDomain: "gallery-1609e.firebaseapp.com",
            projectId: "gallery-1609e",
            storageBucket: "gallery-1609e.firebasestorage.app",
            messagingSenderId: "616484716286",
            appId: "1:616484716286:web:2cdfe99e8698e03687afaf",
            measurementId: "G-F4VM09MT90"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM elements
        const authRequired = document.querySelector('.auth-required');
        const profileContent = document.getElementById('profileContent');
        const displayNameHeader = document.getElementById('displayNameHeader');
        const userEmail = document.getElementById('userEmail');
        const userPhoto = document.getElementById('userPhoto');
        const displayNameInput = document.getElementById('displayName');
        const userBioInput = document.getElementById('userBio');
        const favoriteDestinationInput = document.getElementById('favoriteDestination');
        const locationInput = document.getElementById('location');
        const shareProfileCheckbox = document.getElementById('shareProfile');
        const receiveNotificationsCheckbox = document.getElementById('receiveNotifications');
        const publicProfileCheckbox = document.getElementById('publicProfile');
        const profilePictureInput = document.getElementById('profilePictureInput');
        const profileForm = document.getElementById('profileForm');
        const profileMessage = document.getElementById('profileMessage');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.querySelector('.progress');
        const uploadCount = document.getElementById('uploadCount');
        const likesCount = document.getElementById('likesCount');
        const commentsCount = document.getElementById('commentsCount');
        const memberSince = document.getElementById('memberSince');
        const myUploadsGrid = document.getElementById('my-uploads-grid');
        const noUploadsMessage = document.getElementById('no-uploads-message');
        
        // DOM elements for image upload
        const uploadForm = document.getElementById('uploadForm');
        const imageFile = document.getElementById('imageFile');
        const imagePreview = document.getElementById('imagePreview');
        const imageUploadProgress = document.getElementById('imageUploadProgress');
        const imageUploadProgressBar = document.querySelector('.image-upload-progress');
        const uploadMessage = document.getElementById('uploadMessage');
        
        // DOM elements for profiles stats
        const profileCreationDate = document.getElementById('profileCreationDate');
        const joinedDate = document.getElementById('joinedDate');
        const userLocation = document.getElementById('userLocation');
        const tripCount = document.getElementById('tripCount');
        const domesticCount = document.getElementById('domesticCount');
        const internationalCount = document.getElementById('internationalCount');
        
        // Load user's uploaded images
        async function loadUserUploads(userId) {
            if (!userId || !myUploadsGrid) return;

            try {
                const imagesQuery = query(
                    collection(db, 'images'),
                    where('userId', '==', userId),
                    orderBy('timestamp', 'desc')
                );
                const imagesSnapshot = await getDocs(imagesQuery);

                if (imagesSnapshot.empty) {
                    myUploadsGrid.innerHTML = '';
                    noUploadsMessage.classList.remove('d-none');
                    return;
                }

                noUploadsMessage.classList.add('d-none');
                myUploadsGrid.innerHTML = '';

                imagesSnapshot.forEach(doc => {
                    const imageData = doc.data();
                    const imageCard = createImageCard(doc.id, imageData);
                    myUploadsGrid.appendChild(imageCard);
                });
            } catch (error) {
                console.error("Error loading uploads:", error);
                showErrorMessage("Error loading your uploads. Please try again later.");
            }
        }

        // Create image card element
        function createImageCard(imageId, imageData) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';

            const timestamp = imageData.timestamp?.toDate() || new Date();
            const timeAgo = window.formatTimeAgo(timestamp);

            col.innerHTML = `
                <div class="upload-card">
                    <img src="${imageData.imageUrl}" alt="${imageData.title}">
                    <div class="upload-card-category">${imageData.category}</div>
                    <div class="upload-card-overlay">
                        <div class="upload-card-title">${imageData.title}</div>
                        <div class="upload-card-info">
                            <i class="far fa-clock"></i> ${timeAgo}
                        </div>
                    </div>
                    <div class="upload-card-actions position-absolute top-0 end-0 m-2">
                        <button class="delete-btn" onclick="deleteImage('${imageId}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;

            return col;
        }

        // Helper function to format time ago (make it global)
        window.formatTimeAgo = function(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60,
                second: 1
            };

            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
                }
            }
            return 'Just now';
        };

        // Delete image function
        window.deleteImage = async function(imageId) {
            if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                showErrorMessage('You must be logged in to delete images.');
                return;
            }

            try {
                // Get the image data first to get the storage URL
                const imageDoc = await getDoc(doc(db, 'images', imageId));
                if (!imageDoc.exists()) {
                    showErrorMessage('Image not found.');
                    return;
                }

                const imageData = imageDoc.data();
                if (imageData.userId !== user.uid) {
                    showErrorMessage('You can only delete your own images.');
                    return;
                }

                // Delete the image from Storage
                const imageUrl = imageData.imageUrl;
                const storageRef = ref(storage, imageUrl);
                await deleteObject(storageRef);

                // Delete the image document from Firestore
                await deleteDoc(doc(db, 'images', imageId));

                // Remove the image card from the UI
                const imageCard = document.querySelector(`[data-image-id="${imageId}"]`);
                if (imageCard) {
                    imageCard.closest('.col-md-6').remove();
                }

                // Show success message
                showSuccessMessage('Image deleted successfully.');

                // Refresh user stats
                await fetchUserStats(user.uid);

                // Check if there are any images left
                const remainingImages = myUploadsGrid.children.length;
                if (remainingImages === 0) {
                    noUploadsMessage.classList.remove('d-none');
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                showErrorMessage('Error deleting image. Please try again.');
            }
        };

        // Show success message
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-success border-0';
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            document.querySelector('.toast-container').appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Check authentication status
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                authRequired.style.display = 'none';
                profileContent.style.display = 'block';
                
                // Update UI with user info
                displayNameHeader.textContent = user.displayName || 'User';
                userEmail.textContent = user.email;
                displayNameInput.value = user.displayName || '';
                
                // Set profile picture
                if (user.photoURL) {
                    userPhoto.src = user.photoURL;
                }
                
                // Fetch user data from Firestore
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        // Fill in form with user data
                        userBioInput.value = userData.bio || '';
                        favoriteDestinationInput.value = userData.favoriteDestination || '';
                        locationInput.value = userData.location || '';
                        
                        // Update location display
                        if (userLocation) {
                            userLocation.textContent = userData.location ? `Location: ${userData.location}` : 'Location: N/A';
                        }
                        
                        // Set privacy settings
                        if (userData.privacySettings) {
                            shareProfileCheckbox.checked = userData.privacySettings.shareProfile !== false;
                            receiveNotificationsCheckbox.checked = userData.privacySettings.receiveNotifications !== false;
                            publicProfileCheckbox.checked = userData.privacySettings.publicProfile !== false;
                        }
                        
                        // Format date for display
                        if (userData.createdAt) {
                            const date = new Date(userData.createdAt);
                            const formattedDate = date.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'short'
                            });
                            
                            // Update dates in profile
                            if (memberSince) memberSince.textContent = formattedDate;
                            if (profileCreationDate) profileCreationDate.textContent = formattedDate;
                            if (joinedDate) joinedDate.textContent = 'Joined: ' + formattedDate;
                        }
                    } else {
                        // Create user document if it doesn't exist
                        const creationDate = new Date().toISOString();
                        await setDoc(doc(db, "users", user.uid), {
                            email: user.email,
                            displayName: user.displayName || '',
                            photoURL: user.photoURL || '',
                            bio: '',
                            favoriteDestination: '',
                            location: '',
                            privacySettings: {
                                shareProfile: true,
                                receiveNotifications: true,
                                publicProfile: true
                            },
                            createdAt: creationDate,
                            updatedAt: creationDate
                        });
                        
                        // Format date for display after creation
                        const date = new Date(creationDate);
                        const formattedDate = date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short'
                        });
                        
                        // Update dates in profile
                        if (memberSince) memberSince.textContent = formattedDate;
                        if (profileCreationDate) profileCreationDate.textContent = formattedDate;
                        if (joinedDate) joinedDate.textContent = 'Joined: ' + formattedDate;
                    }
                    
                    // Get user statistics
                    await fetchUserStats(user.uid);
                    
                    // Load user's uploaded images
                    await loadUserUploads(user.uid);
                    
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    profileMessage.innerHTML = `<div class="alert alert-danger">Error loading profile data: ${error.message}</div>`;
                }
                
            } else {
                // No user is signed in
                authRequired.style.display = 'block';
                profileContent.style.display = 'none';
            }
        });
        
        // Handle profile picture change
        profilePictureInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadProfilePicture(file);
            }
        });
        
        // Handle profile form submission
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) return;
            
            const newDisplayName = displayNameInput.value.trim();
            const bio = userBioInput.value.trim();
            const favoriteDestination = favoriteDestinationInput.value.trim();
            const location = locationInput.value.trim();
            const privacySettings = {
                shareProfile: shareProfileCheckbox.checked,
                receiveNotifications: receiveNotificationsCheckbox.checked,
                publicProfile: publicProfileCheckbox.checked
            };
            
            profileMessage.innerHTML = '<div class="alert alert-info">Updating profile...</div>';
            
            try {
                // Update Firebase Auth profile
                await updateProfile(user, {
                    displayName: newDisplayName
                });
                
                // Update Firestore user document
                await updateDoc(doc(db, "users", user.uid), {
                    displayName: newDisplayName,
                    bio: bio,
                    favoriteDestination: favoriteDestination,
                    location: location,
                    privacySettings: privacySettings,
                    updatedAt: new Date().toISOString()
                });
                
                // Log the profile update activity
                try {
                    await addDoc(collection(db, 'user_activities'), {
                        userId: user.uid,
                        type: 'profile_update',
                        details: {
                            displayName: newDisplayName,
                            location: location
                        },
                        timestamp: serverTimestamp()
                    });
                    console.log('Profile update activity logged successfully');
                    
                    // Refresh activities immediately
                    await loadRecentActivities(user.uid);
                } catch (activityError) {
                    console.error('Error logging profile update activity:', activityError);
                }
                
                // Update UI
                displayNameHeader.textContent = newDisplayName || 'User';
                
                // Update location display if it exists
                if (userLocation) {
                    userLocation.textContent = location ? `Location: ${location}` : 'Location: N/A';
                }
                
                profileMessage.innerHTML = '<div class="alert alert-success">Profile updated successfully!</div>';
                
                // Clear message after 3 seconds
                setTimeout(() => {
                    profileMessage.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error("Error updating profile:", error);
                profileMessage.innerHTML = `<div class="alert alert-danger">Error updating profile: ${error.message}</div>`;
            }
        });
        
        // Function to show error messages
        function showErrorMessage(message) {
            if (profileMessage) {
                profileMessage.innerHTML = `<div class="alert alert-danger">${message}</div>`;
                
                // Clear message after 5 seconds
                setTimeout(() => {
                    profileMessage.innerHTML = '';
                }, 5000);
            }
        }
        
        // Upload profile picture
        async function uploadProfilePicture(file) {
            const user = auth.currentUser;
            if (!user) return;
            
            // Show progress bar
            progressBar.style.display = 'block';
            profileMessage.innerHTML = '<div class="alert alert-info">Uploading profile picture...</div>';
            
            try {
                // Create a storage reference
                const storageRef = ref(storage, `profile-pictures/${user.uid}/${Date.now()}_${file.name}`);
                
                // Upload file
                const uploadTask = uploadBytesResumable(storageRef, file);
                
                // Monitor upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Track progress
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadProgress.style.width = progress + '%';
                        uploadProgress.textContent = Math.round(progress) + '%';
                    }, 
                    (error) => {
                        // Handle errors
                        console.error('Upload error:', error);
                        let errorMessage = error.message;
                        
                        // Provide more helpful message for permission errors
                        if (error.code === 'storage/unauthorized' || error.message.includes('permission')) {
                            errorMessage = 'Permission denied. Firebase Storage rules need to be configured. Please check the README for instructions.';
                        }
                        
                        profileMessage.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
                        progressBar.style.display = 'none';
                    }, 
                    async () => {
                        // Upload complete
                        // Get download URL
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        
                        try {
                            // Update Firebase Auth profile
                            await updateProfile(user, {
                                photoURL: downloadURL
                            });
                            
                            // Update Firestore user document
                            await updateDoc(doc(db, "users", user.uid), {
                                photoURL: downloadURL,
                                updatedAt: new Date().toISOString()
                            });
                            
                            // Update UI
                            userPhoto.src = downloadURL;
                            
                            profileMessage.innerHTML = '<div class="alert alert-success">Profile picture updated successfully!</div>';
                            
                            // Hide progress bar after 2 seconds
                            setTimeout(() => {
                                progressBar.style.display = 'none';
                                // Clear message after 3 seconds
                                setTimeout(() => {
                                    profileMessage.innerHTML = '';
                                }, 1000);
                            }, 2000);
                            
                        } catch (error) {
                            console.error("Error updating profile:", error);
                            profileMessage.innerHTML = `<div class="alert alert-danger">Error updating profile: ${error.message}</div>`;
                            progressBar.style.display = 'none';
                        }
                    }
                );
            } catch (error) {
                console.error("Error during upload:", error);
                profileMessage.innerHTML = `<div class="alert alert-danger">Upload failed: ${error.message}</div>`;
                progressBar.style.display = 'none';
            }
        }
        
        // Fetch user statistics
        async function fetchUserStats(userId) {
            if (!userId) return;

            try {
                // Get user's uploaded images
                const imagesQuery = query(
                    collection(db, 'images'),
                    where('userId', '==', userId),
                    orderBy('timestamp', 'desc')
                );
                const imagesSnapshot = await getDocs(imagesQuery);
                const userImageIds = imagesSnapshot.docs.map(doc => doc.id);
                
                // Update upload count
                if (uploadCount) {
                    uploadCount.textContent = imagesSnapshot.size.toString();
                }

                // Count likes on user's photos
                let totalLikes = 0;
                
                // First try to get likes from Firebase
                try {
                    // This method queries all likes where the photoId is in the user's images
                    const userImageIds = imagesSnapshot.docs.map(doc => doc.id);
                    
                    // We'll query in batches of 10 as Firestore has limits on 'in' queries
                    for (let i = 0; i < userImageIds.length; i += 10) {
                        const batch = userImageIds.slice(i, i + 10);
                        if (batch.length > 0) {
                            const likesQuery = query(
                                collection(db, 'likes'),
                                where('photoId', 'in', batch)
                            );
                            const likesSnapshot = await getDocs(likesQuery);
                            totalLikes += likesSnapshot.size;
                        }
                    }
                } catch (error) {
                    console.error("Error counting likes:", error);
                    // Fall back to local storage
                    try {
                        const likes = JSON.parse(localStorage.getItem('gallery_likes') || '{}');
                        // Count likes from local storage
                        for (const photoId in likes) {
                            if (userImageIds.includes(photoId)) {
                                totalLikes += Object.keys(likes[photoId]).length;
                            }
                        }
                    } catch (storageError) {
                        console.error("Error accessing local storage:", storageError);
                    }
                }
                
                // Count comments on user's photos
                let totalComments = 0;
                
                // First try to get comments from Firebase
                try {
                    // This method queries all comments where the photoId is in the user's images
                    // We'll query in batches of 10 as Firestore has limits on 'in' queries
                    for (let i = 0; i < userImageIds.length; i += 10) {
                        const batch = userImageIds.slice(i, i + 10);
                        if (batch.length > 0) {
                            const commentsQuery = query(
                                collection(db, 'comments'),
                                where('photoId', 'in', batch)
                            );
                            const commentsSnapshot = await getDocs(commentsQuery);
                            totalComments += commentsSnapshot.size;
                        }
                    }
                } catch (error) {
                    console.error("Error counting comments:", error);
                    // Fall back to local storage
                    try {
                        const comments = JSON.parse(localStorage.getItem('gallery_comments') || '{}');
                        // Count comments from local storage
                        for (const photoId in comments) {
                            if (userImageIds.includes(photoId)) {
                                totalComments += comments[photoId].length;
                            }
                        }
                    } catch (storageError) {
                        console.error("Error accessing local storage:", storageError);
                    }
                }
                
                // Update UI with like and comment counts
                if (likesCount) likesCount.textContent = totalLikes.toString();
                if (commentsCount) commentsCount.textContent = totalComments.toString();
                
                // Update progress bars for badges
                updateBadgeProgress('likes-progress', totalLikes, 10);           // 10 likes for first badge
                updateBadgeProgress('upload-progress', imagesSnapshot.size, 5);  // 5 uploads for first badge
                updateBadgeProgress('comments-progress', totalComments, 5);      // 5 comments for first badge
                
                // Count unique categories for the Elite Explorer badge
                const userCategories = new Set();
                imagesSnapshot.forEach(doc => {
                    const category = doc.data().category;
                    if (category) userCategories.add(category);
                });
                
                // Categories count (using the progress span instead)
                const categoriesProgressElement = document.getElementById('categoriesProgress');
                if (categoriesProgressElement) {
                    const catCount = userCategories.size;
                    categoriesProgressElement.textContent = `${catCount}/5`;
                    updateBadgeProgress('categories-progress', catCount, 5); // 5 categories for badge
                }
                
                // Get first upload date
                if (imagesSnapshot.size > 0) {
                    // Sort by timestamp (oldest first)
                    const sortedDocs = imagesSnapshot.docs.sort((a, b) => {
                        const timestampA = a.data().timestamp?.toDate() || new Date(0);
                        const timestampB = b.data().timestamp?.toDate() || new Date(0);
                        return timestampA - timestampB;
                    });
                    
                    const firstUpload = sortedDocs[0].data().timestamp?.toDate();
                    if (firstUpload && memberSince) {
                        memberSince.textContent = firstUpload.toLocaleDateString();
                    }
                    
                    // Make photographer badge visible if at least one upload
                    const uploaderBadge = document.getElementById('uploaderBadge');
                    if (uploaderBadge && imagesSnapshot.size > 0) {
                        uploaderBadge.classList.remove('locked-badge');
                    }
                    
                    // Calculate trip counter (one trip = one day with at least one photo)
                    const tripDays = new Set();
                    imagesSnapshot.docs.forEach(doc => {
                        const timestamp = doc.data().timestamp?.toDate();
                        if (timestamp) {
                            const dateString = timestamp.toLocaleDateString();
                            tripDays.add(dateString);
                        }
                    });
                    
                    if (tripCount) {
                        tripCount.textContent = tripDays.size.toString();
                    }
                    
                    // Update domestic and international counts (placeholder for now)
                    if (domesticCount) domesticCount.textContent = '0';
                    if (internationalCount) internationalCount.textContent = '0';
                }
                
            } catch (error) {
                console.error("Error fetching user stats:", error);
                showErrorMessage("Error loading your statistics. Please try again later.");
            }
        }

        // Update badge progress bar
        function updateBadgeProgress(progressId, current, target) {
            const progressBar = document.getElementById(progressId);
            if (!progressBar) return;
            
            const percentage = Math.min(100, Math.floor((current / target) * 100));
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            
            // If completed, add the 'completed' class
            if (current >= target) {
                const badgeCard = progressBar.closest('.badge-card');
                if (badgeCard && !badgeCard.classList.contains('completed')) {
                    badgeCard.classList.add('completed');
                }
            }
        }

        // Preview image before upload
        imageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        });

        // Handle image upload form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) {
                uploadMessage.innerHTML = '<div class="alert alert-danger">You must be logged in to upload images.</div>';
                return;
            }
            
            const file = imageFile.files[0];
            if (!file) {
                uploadMessage.innerHTML = '<div class="alert alert-danger">Please select an image to upload.</div>';
                return;
            }
            
            // Get form values
            const title = document.getElementById('imageTitle').value;
            const description = document.getElementById('imageDescription').value;
            const category = document.getElementById('imageCategory').value;
            
            // Show progress bar
            imageUploadProgressBar.style.display = 'block';
            uploadMessage.innerHTML = '<div class="alert alert-info">Uploading image...</div>';
            
            try {
                // Create a storage reference
                const storageRef = ref(storage, `images/${user.uid}/${Date.now()}_${file.name}`);
                
                // Upload file
                const uploadTask = uploadBytesResumable(storageRef, file);
                
                // Monitor upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Track progress
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        imageUploadProgress.style.width = progress + '%';
                        imageUploadProgress.textContent = Math.round(progress) + '%';
                    }, 
                    (error) => {
                        // Handle errors
                        console.error('Upload error:', error);
                        let errorMessage = error.message;
                        
                        // Provide more helpful message for permission errors
                        if (error.code === 'storage/unauthorized' || error.message.includes('permission')) {
                            errorMessage = 'Permission denied. Firebase Storage rules need to be configured. Please check the README for instructions.';
                        }
                        
                        uploadMessage.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
                        imageUploadProgressBar.style.display = 'none';
                    }, 
                    async () => {
                        // Upload complete
                        // Get download URL
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        
                        try {
                            console.log('Saving image metadata to Firestore...');
                            // Save image metadata to Firestore
                            const imageDoc = await addDoc(collection(db, "images"), {
                                title: title,
                                description: description,
                                category: category,
                                imageUrl: downloadURL,
                                userId: user.uid,
                                userName: user.displayName || user.email,
                                timestamp: serverTimestamp()
                            });
                            
                            console.log('Image metadata saved, logging activity...');
                            
                            // Log the upload activity
                            await addDoc(collection(db, 'user_activities'), {
                                userId: user.uid,
                                type: 'upload',
                                details: {
                                    imageId: imageDoc.id,
                                    title: title,
                                    category: category
                                },
                                timestamp: serverTimestamp()
                            });
                            
                            console.log('Activity logged successfully');
                            
                            // Refresh activities immediately
                            await loadRecentActivities(user.uid);
                            
                            // Show success message
                            uploadMessage.innerHTML = '<div class="alert alert-success">Image uploaded successfully!</div>';
                            
                            // Reset form after 2 seconds
                            setTimeout(() => {
                                uploadForm.reset();
                                imagePreview.style.display = 'none';
                                imageUploadProgressBar.style.display = 'none';
                                // Clear message after 3 seconds
                                setTimeout(() => {
                                    uploadMessage.innerHTML = '';
                                }, 1000);
                            }, 2000);
                        } catch (error) {
                            console.error("Error saving image or logging activity:", error);
                            uploadMessage.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                            imageUploadProgressBar.style.display = 'none';
                        }
                    }
                );
            } catch (error) {
                console.error("Error during upload:", error);
                uploadMessage.innerHTML = `<div class="alert alert-danger">Upload failed: ${error.message}</div>`;
                imageUploadProgressBar.style.display = 'none';
            }
        });

        // Function to load recent activities
        async function loadRecentActivities(userId) {
            console.log('Loading activities for user:', userId);
            const timelineContainer = document.getElementById('activity-timeline');
            if (!timelineContainer) {
                console.error('Timeline container not found');
                return;
            }

            try {
                console.log('Querying activities...');
                const activitiesQuery = query(
                    collection(db, 'user_activities'),
                    where('userId', '==', userId),
                    orderBy('timestamp', 'desc'),
                    limit(5)
                );

                console.log('Fetching activities...');
                const activitiesSnapshot = await getDocs(activitiesQuery);
                console.log('Activities fetched:', activitiesSnapshot.size);
                
                timelineContainer.innerHTML = ''; // Clear existing activities

                if (activitiesSnapshot.empty) {
                    console.log('No activities found');
                    timelineContainer.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-info-circle"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }

                activitiesSnapshot.forEach(doc => {
                    const activity = doc.data();
                    console.log('Processing activity:', activity);
                    const timestamp = activity.timestamp?.toDate() || new Date();
                    const timeAgo = window.formatTimeAgo(timestamp);

                    let icon, title, subtitle = '';
                    switch (activity.type) {
                        case 'upload':
                            icon = 'fas fa-image';
                            title = `Uploaded "${activity.details?.title || 'a photo'}"`;
                            if (activity.details?.category) {
                                subtitle = `in ${activity.details.category}`;
                            }
                            break;
                        case 'like':
                            icon = 'fas fa-heart text-danger';
                            title = `Liked ${activity.details?.photoTitle || 'a photo'}`;
                            if (activity.details?.photographerName) {
                                subtitle = `by ${activity.details.photographerName}`;
                            }
                            break;
                        case 'comment':
                            icon = 'fas fa-comment text-primary';
                            title = `Commented on ${activity.details?.photoTitle || 'a photo'}`;
                            if (activity.details?.comment) {
                                subtitle = `"${activity.details.comment.substring(0, 50)}${activity.details.comment.length > 50 ? '...' : ''}"`;
                            }
                            break;
                        case 'profile_update':
                            icon = 'fas fa-user-edit text-success';
                            title = 'Updated profile';
                            if (activity.details?.location) {
                                subtitle = `Updated location to ${activity.details.location}`;
                            } else if (activity.details?.displayName) {
                                subtitle = `Changed display name to ${activity.details.displayName}`;
                            }
                            break;
                        default:
                            icon = 'fas fa-circle';
                            title = 'Activity recorded';
                    }

                    const activityHtml = `
                        <div class="activity-item mb-3">
                            <div class="d-flex align-items-start">
                                <div class="activity-icon me-3">
                                    <i class="${icon} fa-lg"></i>
                                </div>
                                <div class="activity-content flex-grow-1">
                                    <div class="activity-title fw-semibold">${title}</div>
                                    ${subtitle ? `<div class="activity-subtitle text-muted small">${subtitle}</div>` : ''}
                                    <div class="activity-time text-muted small">${timeAgo}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    timelineContainer.innerHTML += activityHtml;
                });
            } catch (error) {
                console.error('Error loading activities:', error);
                console.error('Error details:', error.message);
                
                // Check if the error is related to missing index
                if (error.message && error.message.includes('requires an index')) {
                    timelineContainer.innerHTML = `
                        <div class="text-center text-warning py-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Activity timeline is being set up...</p>
                            <small class="text-muted">This may take a few minutes. Please refresh the page later.</small>
                        </div>
                    `;
                } else {
                    timelineContainer.innerHTML = `
                        <div class="text-center text-danger py-3">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Error loading activities</p>
                            <small class="text-muted">Please try refreshing the page</small>
                        </div>
                    `;
                }
            }
        }

        // Initialize activities when user logs in
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('User logged in, loading activities...');
                await loadRecentActivities(user.uid);
            }
        });

        // Function to update achievements with detailed logging
        async function updateAchievements(userId) {
            // This function is no longer needed
            return;
        }

        // Add event listener for likes
        document.addEventListener('click', async function(e) {
            if (e.target.matches('.like-button')) {
                const user = auth.currentUser;
                if (!user) return;

                const photoId = e.target.dataset.photoId;
                const photoTitle = e.target.dataset.photoTitle;
                const photographerName = e.target.dataset.photographerName;

                try {
                    // Add like to Firestore
                    await addDoc(collection(db, 'likes'), {
                        userId: user.uid,
                        photoId: photoId,
                        timestamp: serverTimestamp()
                    });

                    // Log the like activity
                    await addDoc(collection(db, 'user_activities'), {
                        userId: user.uid,
                        type: 'like',
                        details: {
                            photoId: photoId,
                            photoTitle: photoTitle,
                            photographerName: photographerName
                        },
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error processing like:', error);
                }
            }
        });

        // Add event listener for comments
        document.addEventListener('submit', async function(e) {
            if (e.target.matches('.comment-form')) {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;

                const photoId = e.target.dataset.photoId;
                const photoTitle = e.target.dataset.photoTitle;
                const commentText = e.target.querySelector('.comment-input').value.trim();

                if (!commentText) return;

                try {
                    // Add comment to Firestore
                    await addDoc(collection(db, 'comments'), {
                        userId: user.uid,
                        photoId: photoId,
                        text: commentText,
                        timestamp: serverTimestamp()
                    });

                    // Log the comment activity
                    await addDoc(collection(db, 'user_activities'), {
                        userId: user.uid,
                        type: 'comment',
                        details: {
                            photoId: photoId,
                            photoTitle: photoTitle,
                            comment: commentText
                        },
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error processing comment:', error);
                }
            }
        });
    </script>
    
    <!-- Custom JS -->
    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/theme.js"></script>
    
    <!-- User Profile Header -->
    <script type="module" src="js/user-profile.js"></script>
</body>
</html> 